<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ¬ Candy Blitz â€” Match-3 on Solana</title>
    <meta name="description"
        content="A fully on-chain Candy Crush game powered by MagicBlock Ephemeral Rollups on Solana">
    <meta name="theme-color" content="#ff1493">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¬</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="game-main.css">
    <link rel="preload" href="photos/special/rocket-h.svg" as="image">
    <link rel="preload" href="photos/special/rocket-v.svg" as="image">
    <link rel="preload" href="photos/special/bomb.svg" as="image">
    <link rel="preload" href="photos/special/rainbow.svg" as="image">
    <link rel="preload" href="photos/special/lightning.svg" as="image">
</head>

<body>
    <!-- Wallet Reconnect Overlay (hidden by default, shown via inline script if wallet was connected) -->
    <div id="walletReconnectOverlay" style="
        display: none;
        position: fixed; inset: 0; z-index: 9999;
        background: rgba(10, 10, 25, 0.92);
        backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
        justify-content: center; align-items: center; flex-direction: column; gap: 20px;
    ">
        <div style="
            width: 56px; height: 56px;
            border: 4px solid rgba(153, 69, 255, 0.2);
            border-top-color: #9945ff;
            border-radius: 50%;
            animation: reconnectSpin 0.8s linear infinite;
        "></div>
        <p style="
            color: #e0e0ff; font-family: 'Comfortaa', sans-serif;
            font-size: 1.1rem; font-weight: 600; text-align: center;
        ">Reconnecting wallet<span id="reconnectDots">...</span></p>
        <p style="
            color: rgba(255,255,255,0.4); font-family: 'Comfortaa', sans-serif;
            font-size: 0.75rem;
        ">Please wait</p>
    </div>
    <style>
        @keyframes reconnectSpin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Instant screen swap + overlay if wallet was previously connected -->
    <script>
        if (localStorage.getItem('candyBlitz_walletProvider')) {
            document.addEventListener('DOMContentLoaded', function () {
                var splash = document.getElementById('startScreen');
                var map = document.getElementById('mapScreen');
                if (splash) splash.classList.add('hidden');
                if (map) map.classList.remove('hidden');
                // Show the blocking reconnect overlay
                var overlay = document.getElementById('walletReconnectOverlay');
                if (overlay) overlay.style.display = 'flex';
            });
        }
    </script>

    <!-- Floating Hearts -->
    <div class="floating-hearts" id="floatingHearts"></div>

    <!-- Start Screen - Candy Splash -->
    <div class="screen" id="startScreen">
        <div class="candy-splash">
            <div class="splash-candies">ğŸ¬ğŸ­ğŸ«ğŸ©ğŸ§ğŸª</div>
            <h1 class="splash-title">Candy Blitz</h1>
            <p class="splash-sub">Match-3 on Solana âš¡</p>
            <p class="splash-desc">Every swap is an on-chain transaction â€” powered by <strong>MagicBlock Ephemeral
                    Rollups</strong></p>
            <button class="btn btn-wallet" id="walletBtn" onclick="openProfile()">ğŸ”— Connect Wallet</button>
            <button class="btn btn-gold splash-btn hidden" id="playBtn" onclick="showMap()">ğŸ® Play</button>
            <p class="splash-disclaimer">âš ï¸ This game runs on <strong>Solana Devnet</strong>. Test SOL required â€” <a
                    href="https://faucet.solana.com/" target="_blank">get free devnet SOL</a></p>
        </div>
    </div>

    <!-- Map Screen -->
    <div class="screen card hidden" id="mapScreen">
        <button class="settings-gear" onclick="openSettings()">âš™ï¸</button>
        <button class="wallet-gear" id="walletBtnMap" onclick="openProfile()">ğŸ”—</button>
        <div class="map-title">
            <h2>ğŸ—ºï¸ Candy World</h2>
            <p class="subtitle">Choose a level</p>
        </div>
        <div class="map-scroll" id="mapScroll">
            <div class="map-path" id="mapPath"></div>
        </div>
        <div id="progressText" style="font-size: 0.9rem; margin-top: 10px;"></div>
        <button class="btn btn-small" onclick="openLeaderboard()" style="margin-top: 10px;">ğŸ† Leaderboard</button>
    </div>

    <!-- Game Screen -->
    <div class="screen hidden" id="gameScreen">
        <div class="game-top-bar">
            <button class="back-btn" onclick="backToMap()">â†</button>
            <div class="game-top-info">
                <div class="level-header" id="levelHeader">ğŸ« Chocolate Factory</div>
                <div class="goal-text" id="goalText">ğŸ¯ Goal: 3000 points</div>
            </div>
            <div class="game-top-spacer"></div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="header">
            <div class="stat">
                <div class="stat-label">Score</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat timer" id="timerBox">
                <div class="stat-label">Time</div>
                <div class="stat-value" id="timer">2:00</div>
            </div>
            <div class="stat">
                <div class="stat-label">Best</div>
                <div class="stat-value" id="bestScoreDisplay">â€”</div>
            </div>
        </div>

        <div class="board-container">
            <div id="erLoadingOverlay" class="er-loading-overlay hidden">
                <div class="er-loading-card">
                    <div class="tx-spinner" style="width: 32px; height: 32px; border-width: 4px;"></div>
                    <span id="erLoadingText">â³ Preparing game...</span>
                </div>
            </div>
            <div class="board" id="board"></div>
        </div>

        <div class="game-bottom-bar">
            <button class="shuffle-btn" id="shuffleBtn" onclick="manualShuffle()">ğŸ”€</button>
            <button class="music-btn" id="musicBtn" onclick="toggleMusic()">ğŸ”Š</button>
        </div>
    </div>

    <!-- Level Complete Screen -->
    <div class="screen card hidden" id="winScreen">
        <div class="hearts win-hearts">ğŸ‰</div>
        <h1>Level Complete!</h1>
        <div id="winStars" class="win-stars-container"></div>
        <div class="result">
            <div class="result-score" id="winScore">2500</div>
            <div class="result-msg" id="winMsg"></div>
        </div>
        <div class="star-thresholds">
            <span>â­ 1500</span>
            <span>â­â­ 3000</span>
            <span>â­â­â­ 4500</span>
        </div>
        <div class="win-candy-icon" style="font-size: 4rem; margin: 1rem 0;">ğŸ¬</div>
        <p class="baby-message" id="winBabyMsg"></p>
        <div id="winTxLoading" class="tx-loading hidden">
            <div class="tx-spinner"></div>
            <span>Saving to blockchain...</span>
        </div>
        <button class="btn btn-gold" id="winMapBtn" onclick="showMap()">To Map ğŸ—ºï¸</button>
    </div>

    <!-- Level Failed Screen -->
    <div class="screen card hidden" id="loseScreen">
        <div class="hearts">ğŸ˜¢</div>
        <h1>Not Enough Points</h1>
        <div class="result">
            <div class="result-score" id="loseScore">1500</div>
            <div class="result-msg">Needed <span id="loseGoal">1500</span></div>
        </div>
        <div style="font-size: 4rem; margin: 1rem 0;">ğŸ’”</div>
        <p class="baby-message" id="loseBabyMsg"></p>
        <button class="btn" onclick="retryLevel()">Retry ğŸ”„</button>
        <button class="btn btn-small" onclick="showMap()">To Map</button>
    </div>

    <!-- Final Congratulations Screen -->
    <div class="screen card hidden" id="congratsScreen">
        <div class="hearts win-hearts">ğŸ†</div>
        <h1 class="congrats-title">Congratulations!</h1>
        <p class="congrats-subtitle">All levels completed!</p>
        <div style="font-size: 5rem; margin: 1rem 0;">ğŸ¬ğŸ†ğŸ¬</div>
        <p class="congrats-message" id="congratsMsg"></p>
        <div class="congrats-stats">
            <div class="congrats-stat">
                <span class="congrats-stat-value" id="congratsTotalStars">0</span>
                <span class="congrats-stat-label">â­ Stars</span>
            </div>
            <div class="congrats-stat">
                <span class="congrats-stat-value" id="congratsTotalScore">0</span>
                <span class="congrats-stat-label">ğŸ¯ Points</span>
            </div>
        </div>
        <p style="color: #14F195; font-size: 0.9rem; margin: 1rem 0 0.5rem;">ğŸ† Your score is saved on Solana! Check the
            Leaderboard to see your rank.</p>
        <button class="btn btn-gold" onclick="openLeaderboard()"
            style="margin-bottom: 0.5rem; background: linear-gradient(135deg, #9945FF, #14F195);">View Leaderboard
            ğŸ“Š</button>
        <button class="btn btn-gold" onclick="showMap()">To Map ğŸ—ºï¸</button>
    </div>

    <!-- Settings Screen -->
    <div class="screen card hidden" id="settingsScreen" style="position: relative;">
        <button class="back-btn" onclick="showMap()"
            style="position: absolute; top: 15px; left: 15px; z-index: 10;">â†</button>
        <div class="hearts">âš™ï¸</div>
        <h1>Settings</h1>
        <div class="settings-panel">
            <div class="settings-item">
                <label class="settings-label" for="volumeSlider">ğŸµ Music Volume</label>
                <div class="volume-control">
                    <span class="volume-icon" id="volumeIcon">ğŸ”Š</span>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="30"
                        oninput="changeVolume(this.value)">
                    <span class="volume-value" id="volumeValue">30%</span>
                </div>
            </div>
            <div class="settings-divider"></div>
            <div class="settings-item">
                <label class="settings-label" for="sfxSlider">ğŸ”Š SFX Volume</label>
                <div class="volume-control">
                    <span class="volume-icon" id="sfxIcon">ğŸ”Š</span>
                    <input type="range" id="sfxSlider" class="volume-slider" min="0" max="100" value="70"
                        oninput="changeSfxVolume(this.value)">
                    <span class="volume-value" id="sfxValue">70%</span>
                </div>
            </div>
            <div class="settings-divider"></div>
            <div class="settings-item">
                <label class="settings-label">ğŸ’¡ Hints</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="hintToggle" checked onchange="toggleHints(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div class="screen card hidden" id="leaderboardScreen" style="position: relative;">
        <button class="back-btn" onclick="showMap()"
            style="position: absolute; top: 15px; left: 15px; z-index: 10;">â†</button>
        <div class="hearts">ğŸ†</div>
        <h1>Leaderboard</h1>
        <p class="subtitle" style="margin-bottom: 15px;">On-chain scores via MagicBlock ER</p>
        <div class="leaderboard-badge">
            <span class="badge-dot"></span>
            <span>Solana Devnet</span>
        </div>
        <div class="leaderboard-table" id="leaderboardTable">
            <div class="lb-header">
                <span class="lb-rank">#</span>
                <span class="lb-player">Player</span>
                <span class="lb-score">Total Score</span>
            </div>
        </div>
        <p class="lb-footer" style="color: #ff4d4d;">Connect wallet to see your rank</p>
    </div>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script type="module" src="game-main.js"></script>
</body>

</html>